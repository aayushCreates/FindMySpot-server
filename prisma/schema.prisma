generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum BookingState {
  INIT
  QUEUED
  ADMITTED
  LOCKED
  PAYMENT_PENDING
  CONFIRMED
  FAILED
  EXPIRED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentMethod {
  UPI
  NETBANKING
  CASH
}

model User {
  id       String @id @default(uuid())
  name     String
  email    String @unique
  phone    String @unique
  password String

  bookings Booking[]
  payments Payment[]

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  queueEntries QueueEntry[]
}

model Slot {
  id         String @id @default(uuid())
  totalSeats Int
  SeatNumbers  Int[]

  bookings Booking[]

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  queueEntries QueueEntry[]
}

model Booking {
  id             String       @id @default(uuid())
  state          BookingState @default(INIT)
  idempotencyKey String       @unique

  slotId String
  slot   Slot   @relation(fields: [slotId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  seatNumber Int?
  payment    Payment?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([slotId, seatNumber])
  @@index([slotId, state])
}

model Payment {
  id     String        @id @default(uuid())
  amount Int
  status PaymentStatus @default(PENDING)
  method PaymentMethod @default(NETBANKING)

  razorpayOrderId   String?
  razorpayPaymentId String?
  razorpaySignature String?

  bookingId String  @unique
  booking   Booking @relation(fields: [bookingId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model QueueEntry {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  slotId String
  slot   Slot   @relation(fields: [slotId], references: [id])

  enteredAt  DateTime  @default(now())
  admittedAt DateTime?

  @@index([slotId, enteredAt])
}
